%%Parameter Idenitification
clear all
tf=2.5;
ts=0.05;
g=9.8;

%Trajectory from Paper
% theta(1,:) = [0, -1.8,-2,-2,-2, -2, -2.2, -2.5, -3, -3, -3.2, -3.2, -3, -3 ,-2.8, -2.2,-2.2, -2.2, -2.2, -2, -2, -1.8, -1.8, -1.5, -1, 0];
% dtheta(1,:)= [0, -1, 0.5, 0, -0.5, -0.5, -0.5, 0, 0.5, 0, -0.3, 0.5, -0.7, 0, 0.5, 0, 0, 0.2, 0, -0.5, -0.1, 0, 0.3, 0.4, 0, 0];
% [Q(1,:),Qd(1,:),Qdd(1,:),T]=Trajectory_f(theta(1,:),dtheta(1,:),tf,ts);
% 
% theta(2,:) = [0,1,2,2,2,2.2,2.2,2.6,2.2,2.2,2.4,1.8,1.8,1.8,1,0.8,0.8,1,0.8,0.6,0.6,0.8,0.6,0.8,1,0];
% dtheta(2,:)= [0,1,0,-0.4,0.2,0,0,2,-1,0,0.2,-0.2,0,-0.2,-1,0.2,0.4,0,0.3,-1,-1.5,-0.3,-0.2,0,-0.2,0];
% [Q(2,:),Qd(2,:),Qdd(2,:),T]=Trajectory_f(theta(2,:),dtheta(2,:),tf,ts);
% 

%Completely Random Trajectories (just look at this HAM)
theta(1,:) = -3.2*rand(1,26)*sign(rand()-0.5);
dtheta(1,:)= rand(1,26)*sign(rand()-0.5);
[Q(1,:),Qd(1,:),Qdd(1,:),T]=Trajectory_f(theta(1,:),dtheta(1,:),tf,ts);

theta(2,:) = 2.2*rand(1,26)*sign(rand()-0.5);
dtheta(2,:)= 1*rand(1,26)*sign(rand()-0.5);
[Q(2,:),Qd(2,:),Qdd(2,:),T]=Trajectory_f(theta(2,:),dtheta(2,:),tf,ts);



W=zeros(2*length(Q),8);
%Test Trajectory for Least squares solution
for i=1:length(Q)
   
q1=Q(1,i);
q2=Q(2,i);


qd1=Qd(1,i);
qd2=Qd(2,i);


qdd1=Qdd(1,i);
qdd2=Qdd(2,i);
 
%Ungrouped Parameters
% W(1+2*(i-1),:)=[ qdd1, qdd1, qdd2,    0, qdd1, qdd2,    0, qdd1, qdd1, qdd1, qdd2,    0, qdd1, -sin(q1), qdd1/2 + (qdd1*cos(2*q2 - (13*pi)/72))/2 - 2*qd1*qd2*sin(2*q2 - (13*pi)/72), -sin(q1)*sin(q2 + (59*pi)/144), qdd1/2 + (qdd1*cos(2*q2 - (13*pi)/72))/2 - 2*qd1*qd2*sin(2*q2 - (13*pi)/72), -sin(q1)*sin(q2 + (59*pi)/144), qdd1/2 + (qdd1*cos(2*q2))/2 - 2*qd1*qd2*sin(2*q2),         (381*qdd1*sin(2*q2 + (59*pi)/144))/2500 - cos(q2)*sin(q1) + (381*qdd1*sin((59*pi)/144))/2500 + (381*qd1*qd2*cos(2*q2 + (59*pi)/144))/625, (145161*qdd1)/12500000 + (145161*qdd1*cos(2*q2 - (13*pi)/72))/12500000 - (381*sin(q1)*sin(q2 + (59*pi)/144))/2500 - (145161*qd1*qd2*sin(2*q2 - (13*pi)/72))/3125000, (145161*qdd1)/8000000 + (145161*qdd1*cos(2*q2))/16000000 - (381*sin(q1)*sin(q2 + pi/3))/2000 + (145161*3^(1/2)*qdd1*sin(2*q2))/16000000 - (145161*qd1*qd2*sin(2*q2))/4000000 + (145161*3^(1/2)*qd1*qd2*cos(2*q2))/4000000, (145161*qdd1)/12500000 + (145161*qdd1*cos(2*q2 - (13*pi)/72))/12500000 - (381*sin(q1)*sin(q2 + (59*pi)/144))/2500 - (145161*qd1*qd2*sin(2*q2 - (13*pi)/72))/3125000];
% W(2+2*(i-1),:)=[    0,    0, qdd1, qdd2,    0, qdd1, qdd2,    0,    0,    0, qdd1, qdd2,    0,        0,                                         sin(2*q2 - (13*pi)/72)*qd1^2 + qdd2,  cos(q1)*cos(q2 + (59*pi)/144),                                         sin(2*q2 - (13*pi)/72)*qd1^2 + qdd2,  cos(q1)*cos(q2 + (59*pi)/144),                            sin(2*q2)*qd1^2 + qdd2, - cos(q1)*sin(q2) - (381*qdd2*sin(2*q2 + (59*pi)/144))/1250 - (381*qd1^2*cos(2*q2 + (59*pi)/144))/1250 - (381*qd2^2*cos(2*q2 + (59*pi)/144))/625,                                                    (145161*sin(2*q2 - (13*pi)/72)*qd1^2)/6250000 + (145161*qdd2)/6250000 + (381*cos(q1)*cos(q2 + (59*pi)/144))/2500,                                                                                   (145161*qdd2)/4000000 + (381*cos(q1)*cos(q2 + pi/3))/2000 + (145161*qd1^2*sin(2*q2))/8000000 - (145161*3^(1/2)*qd1^2*cos(2*q2))/8000000,                                                    (145161*sin(2*q2 - (13*pi)/72)*qd1^2)/6250000 + (145161*qdd2)/6250000 + (381*cos(q1)*cos(q2 + (59*pi)/144))/2500];
  
%Yb Grouped Parameters
% W(1+2*(i-1),:)=[ qdd1, qdd2,    0, -sin(q1), qdd1/2 + (qdd1*cos(2*q2 - (13*pi)/72))/2 - 2*qd1*qd2*sin(2*q2 - (13*pi)/72), -sin(q1)*sin(q2 + (59*pi)/144), qdd1/2 + (qdd1*cos(2*q2 - (13*pi)/72))/2 - 2*qd1*qd2*sin(2*q2 - (13*pi)/72), -sin(q1)*sin(q2 + (59*pi)/144), qdd1/2 + (qdd1*cos(2*q2))/2 - 2*qd1*qd2*sin(2*q2),         (381*qdd1*sin(2*q2 + (59*pi)/144))/2500 - cos(q2)*sin(q1) + (381*qdd1*sin((59*pi)/144))/2500 + (381*qd1*qd2*cos(2*q2 + (59*pi)/144))/625, (145161*qdd1)/12500000 + (145161*qdd1*cos(2*q2 - (13*pi)/72))/12500000 - (381*sin(q1)*sin(q2 + (59*pi)/144))/2500 - (145161*qd1*qd2*sin(2*q2 - (13*pi)/72))/3125000, (145161*qdd1)/8000000 + (145161*qdd1*cos(2*q2))/16000000 - (381*sin(q1)*sin(q2 + pi/3))/2000 + (145161*3^(1/2)*qdd1*sin(2*q2))/16000000 - (145161*qd1*qd2*sin(2*q2))/4000000 + (145161*3^(1/2)*qd1*qd2*cos(2*q2))/4000000, (145161*qdd1)/12500000 + (145161*qdd1*cos(2*q2 - (13*pi)/72))/12500000 - (381*sin(q1)*sin(q2 + (59*pi)/144))/2500 - (145161*qd1*qd2*sin(2*q2 - (13*pi)/72))/3125000];
% W(2+2*(i-1),:)=[    0, qdd1, qdd2,        0,                                         sin(2*q2 - (13*pi)/72)*qd1^2 + qdd2,  cos(q1)*cos(q2 + (59*pi)/144),                                         sin(2*q2 - (13*pi)/72)*qd1^2 + qdd2,  cos(q1)*cos(q2 + (59*pi)/144),                            sin(2*q2)*qd1^2 + qdd2, - cos(q1)*sin(q2) - (381*qdd2*sin(2*q2 + (59*pi)/144))/1250 - (381*qd1^2*cos(2*q2 + (59*pi)/144))/1250 - (381*qd2^2*cos(2*q2 + (59*pi)/144))/625,                                                    (145161*sin(2*q2 - (13*pi)/72)*qd1^2)/6250000 + (145161*qdd2)/6250000 + (381*cos(q1)*cos(q2 + (59*pi)/144))/2500,                                                                                   (145161*qdd2)/4000000 + (381*cos(q1)*cos(q2 + pi/3))/2000 + (145161*qd1^2*sin(2*q2))/8000000 - (145161*3^(1/2)*qd1^2*cos(2*q2))/8000000,                                                    (145161*sin(2*q2 - (13*pi)/72)*qd1^2)/6250000 + (145161*qdd2)/6250000 + (381*cos(q1)*cos(q2 + (59*pi)/144))/2500];
 
%Yc Grouped Parameters
% W(1+2*(i-1),:)=[ qdd1 - sin(q1), qdd2,    0, qdd1/2 + (qdd1*cos(2*q2 - (13*pi)/72))/2 - 2*qd1*qd2*sin(2*q2 - (13*pi)/72), -sin(q1)*sin(q2 + (59*pi)/144), qdd1/2 + (qdd1*cos(2*q2 - (13*pi)/72))/2 - 2*qd1*qd2*sin(2*q2 - (13*pi)/72), -sin(q1)*sin(q2 + (59*pi)/144), qdd1/2 + (qdd1*cos(2*q2))/2 - 2*qd1*qd2*sin(2*q2),         (381*qdd1*sin(2*q2 + (59*pi)/144))/2500 - cos(q2)*sin(q1) + (381*qdd1*sin((59*pi)/144))/2500 + (381*qd1*qd2*cos(2*q2 + (59*pi)/144))/625, (145161*qdd1)/12500000 + (145161*qdd1*cos(2*q2 - (13*pi)/72))/12500000 - (381*sin(q1)*sin(q2 + (59*pi)/144))/2500 - (145161*qd1*qd2*sin(2*q2 - (13*pi)/72))/3125000, (145161*qdd1)/8000000 + (145161*qdd1*cos(2*q2))/16000000 - (381*sin(q1)*sin(q2 + pi/3))/2000 + (145161*3^(1/2)*qdd1*sin(2*q2))/16000000 - (145161*qd1*qd2*sin(2*q2))/4000000 + (145161*3^(1/2)*qd1*qd2*cos(2*q2))/4000000, (145161*qdd1)/12500000 + (145161*qdd1*cos(2*q2 - (13*pi)/72))/12500000 - (381*sin(q1)*sin(q2 + (59*pi)/144))/2500 - (145161*qd1*qd2*sin(2*q2 - (13*pi)/72))/3125000];
% W(2+2*(i-1),:)=[              0, qdd1, qdd2,                                         sin(2*q2 - (13*pi)/72)*qd1^2 + qdd2,  cos(q1)*cos(q2 + (59*pi)/144),                                         sin(2*q2 - (13*pi)/72)*qd1^2 + qdd2,  cos(q1)*cos(q2 + (59*pi)/144),                            sin(2*q2)*qd1^2 + qdd2, - cos(q1)*sin(q2) - (381*qdd2*sin(2*q2 + (59*pi)/144))/1250 - (381*qd1^2*cos(2*q2 + (59*pi)/144))/1250 - (381*qd2^2*cos(2*q2 + (59*pi)/144))/625,                                                    (145161*sin(2*q2 - (13*pi)/72)*qd1^2)/6250000 + (145161*qdd2)/6250000 + (381*cos(q1)*cos(q2 + (59*pi)/144))/2500,                                                                                   (145161*qdd2)/4000000 + (381*cos(q1)*cos(q2 + pi/3))/2000 + (145161*qd1^2*sin(2*q2))/8000000 - (145161*3^(1/2)*qd1^2*cos(2*q2))/8000000,                                                    (145161*sin(2*q2 - (13*pi)/72)*qd1^2)/6250000 + (145161*qdd2)/6250000 + (381*cos(q1)*cos(q2 + (59*pi)/144))/2500];
%  
%Yd Grouped Parameters
% W(1+2*(i-1),:)=[ qdd1 - sin(q1), qdd2,    0, qdd1 + qdd1*cos(2*q2 - (13*pi)/72) - 4*qd1*qd2*sin(2*q2 - (13*pi)/72), -2*sin(q1)*sin(q2 + (59*pi)/144), qdd1/2 + (qdd1*cos(2*q2))/2 - 2*qd1*qd2*sin(2*q2),         (381*qdd1*sin(2*q2 + (59*pi)/144))/2500 - cos(q2)*sin(q1) + (381*qdd1*sin((59*pi)/144))/2500 + (381*qd1*qd2*cos(2*q2 + (59*pi)/144))/625, (145161*qdd1)/6250000 + (145161*qdd1*cos(2*q2 - (13*pi)/72))/6250000 - (381*sin(q1)*sin(q2 + (59*pi)/144))/1250 - (145161*qd1*qd2*sin(2*q2 - (13*pi)/72))/1562500, (145161*qdd1)/8000000 + (145161*qdd1*cos(2*q2))/16000000 - (381*sin(q1)*sin(q2 + pi/3))/2000 + (145161*3^(1/2)*qdd1*sin(2*q2))/16000000 - (145161*qd1*qd2*sin(2*q2))/4000000 + (145161*3^(1/2)*qd1*qd2*cos(2*q2))/4000000];
% W(2+2*(i-1),:)=[              0, qdd1, qdd2,                               2*sin(2*q2 - (13*pi)/72)*qd1^2 + 2*qdd2,  2*cos(q1)*cos(q2 + (59*pi)/144),                            sin(2*q2)*qd1^2 + qdd2, - cos(q1)*sin(q2) - (381*qdd2*sin(2*q2 + (59*pi)/144))/1250 - (381*qd1^2*cos(2*q2 + (59*pi)/144))/1250 - (381*qd2^2*cos(2*q2 + (59*pi)/144))/625,                                                  (145161*sin(2*q2 - (13*pi)/72)*qd1^2)/3125000 + (145161*qdd2)/3125000 + (381*cos(q1)*cos(q2 + (59*pi)/144))/1250,                                                                                   (145161*qdd2)/4000000 + (381*cos(q1)*cos(q2 + pi/3))/2000 + (145161*qd1^2*sin(2*q2))/8000000 - (145161*3^(1/2)*qd1^2*cos(2*q2))/8000000];
%  
%Ye Grouped Parameters
W(1+2*(i-1),:)=[ qdd1 - sin(q1), qdd2,    0, qdd1 + qdd1*cos(2*q2 - (13*pi)/72) - 4*qd1*qd2*sin(2*q2 - (13*pi)/72), (145161*qdd1)/6250000 + (145161*qdd1*cos(2*q2 - (13*pi)/72))/6250000 - (2881*sin(q1)*sin(q2 + (59*pi)/144))/1250 - (145161*qd1*qd2*sin(2*q2 - (13*pi)/72))/1562500, qdd1/2 + (qdd1*cos(2*q2))/2 - 2*qd1*qd2*sin(2*q2),         (381*qdd1*sin(2*q2 + (59*pi)/144))/2500 - cos(q2)*sin(q1) + (381*qdd1*sin((59*pi)/144))/2500 + (381*qd1*qd2*cos(2*q2 + (59*pi)/144))/625, (145161*qdd1)/8000000 + (145161*qdd1*cos(2*q2))/16000000 - (381*sin(q1)*sin(q2 + pi/3))/2000 + (145161*3^(1/2)*qdd1*sin(2*q2))/16000000 - (145161*qd1*qd2*sin(2*q2))/4000000 + (145161*3^(1/2)*qd1*qd2*cos(2*q2))/4000000];
W(2+2*(i-1),:)=[              0, qdd1, qdd2,                               2*sin(2*q2 - (13*pi)/72)*qd1^2 + 2*qdd2,                                                  (145161*sin(2*q2 - (13*pi)/72)*qd1^2)/3125000 + (145161*qdd2)/3125000 + (2881*cos(q1)*cos(q2 + (59*pi)/144))/1250,                            sin(2*q2)*qd1^2 + qdd2, - cos(q1)*sin(q2) - (381*qdd2*sin(2*q2 + (59*pi)/144))/1250 - (381*qd1^2*cos(2*q2 + (59*pi)/144))/1250 - (381*qd2^2*cos(2*q2 + (59*pi)/144))/625,                                                                                   (145161*qdd2)/4000000 + (381*cos(q1)*cos(q2 + pi/3))/2000 + (145161*qd1^2*sin(2*q2))/8000000 - (145161*3^(1/2)*qd1^2*cos(2*q2))/8000000];
 
%lumping dynamics stop on Ye because null check is an empty matrix and
%Cond, and Condf, are not inf values. 

%The resulting lumped parameters are: 
%Par_e = [ I1_xx + I2_xx + I3_xx + I4_xx + I5_xx + I6_xx + lc1_2_m1 +
%alpha1*lc1_m1, I2_xx + I3_xz + I6_xz, I2_xz + I3_zz + I6_zz, lc2_2_m2 + alpha2*lc3_2_m3, lc2_m2 + alpha3*lc3_m3 + alpha5*(m4 + alpha4*m6), lc6_2_m6, lc6_m6, m5];
 
end

check=null(W);



Cond=cond(W,2);
Condf=cond(W'*W,'fro');
close all

