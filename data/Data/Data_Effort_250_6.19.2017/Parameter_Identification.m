%%Parameter Idenitification
clear all

gear12 =  56.8;
gear3  = 336.6; 

convM2cm=100*100;

pos=csvread('data_position.csv');
vel=csvread('data_velocity.csv');
tor=csvread('data_torque.csv');

hz=250;
time=linspace(0,length(vel),length(vel)+1)*1/hz;

for i=1:length(vel)-1
    acc(i,1)=(vel(i+1,1)-vel(i,1))*hz;
    acc(i,2)=(vel(i+1,2)-vel(i,2))*hz;
    acc(i,3)=(vel(i+1,3)-vel(i,3))*hz;
end

for i=1:length(tor)-1
    torque(3*(i-1)+1)=tor(i,1)*gear12*convM2cm;
    torque(3*(i-1)+2)=tor(i,2)*gear12*convM2cm;
    torque(3*(i-1)+3)=tor(i,3)*gear3*convM2cm;
end

Q(1:3,:)=pos(:,1:3)';
Qd(1:3,:)=vel(:,1:3)';
Qdd(1:3,:)=acc(:,1:3)';

for i=1:length(Q)-1
   
q1=Q(1,i);
q2=Q(2,i);
q3=Q(3,i);

qd1=Qd(1,i);
qd2=Qd(2,i);
qd3=Qd(3,i);

qdd1=Qdd(1,i);
qdd2=Qdd(2,i);
qdd3=Qdd(3,i);   

W(1+3*(i-1),:)=[qdd1, qdd1, qdd2,    0, qdd1, qdd2,    0, qdd1, qdd1, qdd1, qdd2,    0, qdd1, qdd2,    0, qdd1, -sin(q1),                          qdd1/2 - (qdd1*cos(2*q2))/2 + (qdd2*sin(2*q2))/4 - (qdd2*cos(2*q1 - 2*q2))/8 + (qdd2*cos(2*q1 + 2*q2))/8 - (qdd2*sin(2*q1 - 2*q2))/8 + (qdd2*sin(2*q1 + 2*q2))/8 + (qd2^2*cos(2*q2))/2 + (qd2^2*sin(2*q1))/2 + (qd2^2*cos(2*q1 - 2*q2))/4 + (qd2^2*cos(2*q1 + 2*q2))/4 + (qd1*qd2*cos(2*q2))/4 + (qd2*qd3*cos(2*q2))/4 + (qd1*qd2*sin(2*q2))/2 + (qd1*qd2*cos(2*q1 - 2*q2))/4 + (qd2*qd3*cos(2*q1 - 2*q2))/8 + (qd2*qd3*cos(2*q1 + 2*q2))/8 - (qd1*qd2*sin(2*q1 - 2*q2))/4 - (qd2*qd3*sin(2*q1 - 2*q2))/8 - (qd2*qd3*sin(2*q1 + 2*q2))/8, cos(q1 + q2)/2 - cos(q1 - q2)/2, qdd1/2 - (qdd1*cos(2*q1))/2 - (qdd1*cos(2*q2))/2 + (qdd2*sin(2*q2))/4 + (qdd1*cos(2*q1 - 2*q2))/4 + (qdd1*cos(2*q1 + 2*q2))/4 - (qdd2*cos(2*q1 - 2*q2))/8 + (qdd2*cos(2*q1 + 2*q2))/8 + (qdd2*sin(2*q1 - 2*q2))/8 - (qdd2*sin(2*q1 + 2*q2))/8 + (qd2^2*cos(2*q2))/2 + (qd1^2*sin(2*q1))/2 - (qd2^2*cos(2*q1 - 2*q2))/4 - (qd2^2*cos(2*q1 + 2*q2))/4 - (qd1^2*sin(2*q1 - 2*q2))/4 - (qd1^2*sin(2*q1 + 2*q2))/4 - (qd2^2*sin(2*q1 - 2*q2))/4 - (qd2^2*sin(2*q1 + 2*q2))/4 + (qd1*qd2*cos(2*q2))/4 + (qd2*qd3*cos(2*q2))/4 + (qd1*qd2*sin(2*q1))/2 + (qd1*qd2*sin(2*q2))/2 + (qd1*qd3*sin(2*q1))/2 - (qd1*qd2*cos(2*q1 - 2*q2))/4 - (qd2*qd3*cos(2*q1 - 2*q2))/8 - (qd2*qd3*cos(2*q1 + 2*q2))/8 - (qd1*qd2*sin(2*q1 - 2*q2))/4 - (qd1*qd2*sin(2*q1 + 2*q2))/2 - (qd1*qd3*sin(2*q1 - 2*q2))/4 - (qd1*qd3*sin(2*q1 + 2*q2))/4 - (qd2*qd3*sin(2*q1 - 2*q2))/8 - (qd2*qd3*sin(2*q1 + 2*q2))/8, cos(q1 + q2)/2 - cos(q1 - q2)/2,    qdd1/2 - (qdd1*cos(2*q2 - (13*pi)/75))/2 + (qd1*qd2*sin(2*q2 - (13*pi)/75))/2,       60*qdd1*cos((13*pi)/150) - 60*qdd1*cos(2*q2 - (13*pi)/150) + 60*qd1*qd2*sin(2*q2 - (13*pi)/150),         cos(q1 + q2 - (13*pi)/150)/2 - cos(q1 - q2 + (13*pi)/150)/2, 0, 0, 0, 1800*qdd1 - 30*cos(q1 - q2) + 30*cos(q1 + q2) - 1800*qdd1*cos(2*q2) + 1800*qd1*qd2*sin(2*q2), 1850*qdd1 - 30*cos(q1 - q2) + 5*cos(q1 + q2 - (13*pi)/150) + 30*cos(q1 + q2) - 5*cos(q1 - q2 + (13*pi)/150) - 1800*qdd1*cos(2*q2) - 50*qdd1*cos(2*q2 - (13*pi)/75) - 600*qdd1*cos(2*q2 - (13*pi)/150) + 600*qdd1*cos((13*pi)/150) + 1800*qd1*qd2*sin(2*q2) + 50*qd1*qd2*sin(2*q2 - (13*pi)/75) + 600*qd1*qd2*sin(2*q2 - (13*pi)/150), 1800*qdd1 - 1800*qdd1*cos(2*q2) + 1800*qd1*qd2*sin(2*q2), 25550*qdd1 - 30*cos(q1 - q2) + 50*cos(2*q1 - (13*pi)/150) + 30*cos(q1 + q2) - 1800*qdd1*cos(2*q2) + (qd3^2*cos(q1))/2 - q3*cos(2*q1 - (13*pi)/150) - 1250*qdd1*cos(2*q1 - (13*pi)/75) - 3750*qdd1*cos(4*q1 - (13*pi)/75) + 50*qdd3*cos(3*q1 - (13*pi)/75) + (qd3^2*sin(q1))/2 + 75*qdd3*sin(2*q1 - (13*pi)/75) - 25*qdd3*sin(3*q1 - (13*pi)/75) + (qd3^2*sin(q1 - (13*pi)/75))/2 - 3000*qdd1*cos(q1 + q2 - (13*pi)/150) - 4500*qdd1*cos(q1 + q2 + (13*pi)/150) + 9000*qdd2*cos(q1 + q2 - (13*pi)/150) + 750*qdd2*cos(q1 + q2 + (13*pi)/150) + 900*qdd2*cos(2*q1 - 2*q2) - 900*qdd2*cos(2*q1 + 2*q2) - 350*q3*qdd1 - 175*qd1*qd3 - (qd3^2*cos(3*q1 - (13*pi)/75))/2 + 1250*qd1^2*sin(2*q1 - (13*pi)/75) + 7500*qd1^2*sin(4*q1 - (13*pi)/75) - qd3^2*sin(2*q1 - (13*pi)/75) + 4500*qdd1*cos(q1 - q2 + (13*pi)/150) + 3000*qdd1*cos(q2 - q1 + (13*pi)/150) + 750*qdd2*cos(q1 - q2 + (13*pi)/150) + 4500*qdd1*cos(q2 - 3*q1 + (13*pi)/150) - 4500*qdd1*cos(3*q1 + q2 - (13*pi)/150) - 750*qdd2*cos(q2 - 3*q1 + (13*pi)/150) - 750*qdd2*cos(3*q1 + q2 - (13*pi)/150) - 15*qdd3*cos(q2 - 2*q1 + (13*pi)/150) + 15*qdd3*cos(2*q1 + q2 - (13*pi)/150) + 15*qdd3*sin(q2 - 2*q1 + (13*pi)/150) + 15*qdd3*sin(2*q1 + q2 - (13*pi)/150) + 1500*qd1^2*sin(q1 + q2 - (13*pi)/150) + 2250*qd1^2*sin(q1 + q2 + (13*pi)/150) - 9000*qd2^2*sin(q1 + q2 - (13*pi)/150) - 750*qd2^2*sin(q1 + q2 + (13*pi)/150) + (3*q3^2*qdd1)/2 + 1800*qd2^2*sin(2*q1 - 2*q2) + 1800*qd2^2*sin(2*q1 + 2*q2) - 25*qdd3*cos(q1) - 25*qdd3*cos(q1 - (13*pi)/75) + 15*qdd3*cos(q2 - (13*pi)/150) - 15*qdd3*cos(q2 + (13*pi)/150) - 25*qdd3*sin(q1) - 50*qdd3*sin(q1 - (13*pi)/75) - 15*qdd3*sin(q2 - (13*pi)/150) - 15*qdd3*sin(q2 + (13*pi)/150) + 3750*qdd1*cos((13*pi)/75) - 2250*qd1^2*sin(q1 - q2 + (13*pi)/150) + 1500*qd1^2*sin(q2 - q1 + (13*pi)/150) + 750*qd2^2*sin(q1 - q2 + (13*pi)/150) + 6750*qd1^2*sin(q2 - 3*q1 + (13*pi)/150) + 6750*qd1^2*sin(3*q1 + q2 - (13*pi)/150) + 750*qd2^2*sin(q2 - 3*q1 + (13*pi)/150) + 750*qd2^2*sin(3*q1 + q2 - (13*pi)/150) - 30*q3*qd1^2*sin(q1 + q2 - (13*pi)/150) - 15*q3*qd1^2*sin(q1 + q2 + (13*pi)/150) + 60*q3*qd2^2*sin(q1 + q2 - (13*pi)/150) + 15*q3*qd2^2*sin(q1 + q2 + (13*pi)/150) + 750*qd1*qd2*sin(q1 - q2 + (13*pi)/150) - 2250*qd1*qd3*sin(q1 - q2 + (13*pi)/150) + 1500*qd1*qd3*sin(q2 - q1 + (13*pi)/150) + 6000*qd1*qd2*sin(q2 - 3*q1 + (13*pi)/150) + 8250*qd1*qd2*sin(3*q1 + q2 - (13*pi)/150) + 15*qd1*qd3*sin(q2 - 2*q1 + (13*pi)/150) + 15*qd1*qd3*sin(2*q1 + q2 - (13*pi)/150) + 375*qd2*qd3*sin(q1 - q2 + (13*pi)/150) + 6750*qd1*qd3*sin(q2 - 3*q1 + (13*pi)/150) + 6750*qd1*qd3*sin(3*q1 + q2 - (13*pi)/150) - (45*qd2*qd3*sin(q2 - 2*q1 + (13*pi)/150))/2 + (45*qd2*qd3*sin(2*q1 + q2 - (13*pi)/150))/2 + 375*qd2*qd3*sin(q2 - 3*q1 + (13*pi)/150) + 375*qd2*qd3*sin(3*q1 + q2 - (13*pi)/150) + (q3*qdd3*cos(q1))/2 + (51*qd1*qd3*cos(q1))/4 + (qd2*qd3*cos(q1))/4 + 25*qd1*qd3*cos(q1 - (13*pi)/75) - (15*qd2*qd3*cos(q2 - (13*pi)/150))/2 - (15*qd2*qd3*cos(q2 + (13*pi)/150))/2 + (q3*qdd3*sin(q1))/2 - (49*qd1*qd3*sin(q1))/4 + (qd2*qd3*sin(q1))/4 + (q3*qdd3*sin(q1 - (13*pi)/75))/2 - (49*qd1*qd3*sin(q1 - (13*pi)/75))/4 + (qd2*qd3*sin(q1 - (13*pi)/75))/4 - (15*qd2*qd3*sin(q2 - (13*pi)/150))/2 + (15*qd2*qd3*sin(q2 + (13*pi)/150))/2 + (q3^2*qd1^2*sin(2*q1 - (13*pi)/75))/2 + q3^2*qd1^2*sin(4*q1 - (13*pi)/75) - 100*q3*qdd1*cos((13*pi)/75) - 50*qd1*qd3*cos((13*pi)/75) + 15*q3*qd1^2*sin(q1 - q2 + (13*pi)/150) - 30*q3*qd1^2*sin(q2 - q1 + (13*pi)/150) - 15*q3*qd2^2*sin(q1 - q2 + (13*pi)/150) - 45*q3*qd1^2*sin(q2 - 3*q1 + (13*pi)/150) - 45*q3*qd1^2*sin(3*q1 + q2 - (13*pi)/150) - 15*q3*qd2^2*sin(q2 - 3*q1 + (13*pi)/150) - 15*q3*qd2^2*sin(3*q1 + q2 - (13*pi)/150) + 50*q3*qdd1*cos(2*q1 - (13*pi)/75) + 100*q3*qdd1*cos(4*q1 - (13*pi)/75) - (q3*qdd3*cos(3*q1 - (13*pi)/75))/2 - 50*qd1*qd3*cos(2*q1 - (13*pi)/75) + (149*qd1*qd3*cos(3*q1 - (13*pi)/75))/4 + 50*qd1*qd3*cos(4*q1 - (13*pi)/75) - (qd2*qd3*cos(3*q1 - (13*pi)/75))/4 + 1800*qd1*qd2*sin(2*q2) - (q3*qdd3*sin(2*q1 - (13*pi)/75))/2 + 1250*qd1*qd2*sin(2*q1 - (13*pi)/75) + (4999*qd1*qd3*sin(2*q1 - (13*pi)/75))/4 + 7500*qd1*qd2*sin(4*q1 - (13*pi)/75) + 75*qd1*qd3*sin(3*q1 - (13*pi)/75) - (qd2*qd3*sin(2*q1 - (13*pi)/75))/4 + 7500*qd1*qd3*sin(4*q1 - (13*pi)/75) + 60*q3*qdd1*cos(q1 + q2 - (13*pi)/150) + 30*q3*qdd1*cos(q1 + q2 + (13*pi)/150) - 60*q3*qdd2*cos(q1 + q2 - (13*pi)/150) - 15*q3*qdd2*cos(q1 + q2 + (13*pi)/150) + 30*qd1*qd3*cos(q1 + q2 - (13*pi)/150) + 15*qd1*qd3*cos(q1 + q2 + (13*pi)/150) - (15*qd2*qd3*cos(q1 + q2 + (13*pi)/150))/2 + 3000*qd1*qd2*sin(q1 + q2 - (13*pi)/150) + 4500*qd1*qd2*sin(q1 + q2 + (13*pi)/150) + 1500*qd1*qd3*sin(q1 + q2 - (13*pi)/150) + 2250*qd1*qd3*sin(q1 + q2 + (13*pi)/150) - 4500*qd2*qd3*sin(q1 + q2 - (13*pi)/150) - 375*qd2*qd3*sin(q1 + q2 + (13*pi)/150) + (3*q3*qd1*qd3)/2 + (q3^2*qdd1*cos((13*pi)/75))/2 + 1800*qd1*qd2*sin(2*q1 - 2*q2) + 900*qd2*qd3*sin(2*q1 - 2*q2) + 900*qd2*qd3*sin(2*q1 + 2*q2) - (q3^2*qdd1*cos(2*q1 - (13*pi)/75))/2 - (q3^2*qdd1*cos(4*q1 - (13*pi)/75))/2 - 50*q3*qd1^2*sin(2*q1 - (13*pi)/75) - 200*q3*qd1^2*sin(4*q1 - (13*pi)/75) - 30*q3*qdd1*cos(q1 - q2 + (13*pi)/150) - 60*q3*qdd1*cos(q2 - q1 + (13*pi)/150) - 15*q3*qdd2*cos(q1 - q2 + (13*pi)/150) - 30*q3*qdd1*cos(q2 - 3*q1 + (13*pi)/150) + 30*q3*qdd1*cos(3*q1 + q2 - (13*pi)/150) + 15*q3*qdd2*cos(q2 - 3*q1 + (13*pi)/150) + 15*q3*qdd2*cos(3*q1 + q2 - (13*pi)/150) - 15*qd1*qd3*cos(q1 - q2 + (13*pi)/150) - 30*qd1*qd3*cos(q2 - q1 + (13*pi)/150) + 15*qd1*qd3*cos(q2 - 2*q1 + (13*pi)/150) - 15*qd1*qd3*cos(2*q1 + q2 - (13*pi)/150) - (15*qd2*qd3*cos(q1 - q2 + (13*pi)/150))/2 - 30*qd2*qd3*cos(q2 - q1 + (13*pi)/150) - 15*qd1*qd3*cos(q2 - 3*q1 + (13*pi)/150) + 15*qd1*qd3*cos(3*q1 + q2 - (13*pi)/150) + (75*qd2*qd3*cos(q2 - 2*q1 + (13*pi)/150))/2 + (75*qd2*qd3*cos(2*q1 + q2 - (13*pi)/150))/2 + (15*qd2*qd3*cos(q2 - 3*q1 + (13*pi)/150))/2 + (15*qd2*qd3*cos(3*q1 + q2 - (13*pi)/150))/2 - 50*q3*qd1*qd2*sin(2*q1 - (13*pi)/75) - 50*q3*qd1*qd3*sin(2*q1 - (13*pi)/75) - 200*q3*qd1*qd2*sin(4*q1 - (13*pi)/75) - (3*q3*qd1*qd3*sin(3*q1 - (13*pi)/75))/4 - 200*q3*qd1*qd3*sin(4*q1 - (13*pi)/75) - 60*q3*qd1*qd2*sin(q1 + q2 - (13*pi)/150) - 30*q3*qd1*qd2*sin(q1 + q2 + (13*pi)/150) - 30*q3*qd1*qd3*sin(q1 + q2 - (13*pi)/150) - 15*q3*qd1*qd3*sin(q1 + q2 + (13*pi)/150) + 30*q3*qd2*qd3*sin(q1 + q2 - (13*pi)/150) + (15*q3*qd2*qd3*sin(q1 + q2 + (13*pi)/150))/2 + (q3^2*qd1*qd2*sin(2*q1 - (13*pi)/75))/2 + (q3^2*qd1*qd3*sin(2*q1 - (13*pi)/75))/2 + q3^2*qd1*qd2*sin(4*q1 - (13*pi)/75) + q3^2*qd1*qd3*sin(4*q1 - (13*pi)/75) - 15*q3*qd1*qd2*sin(q1 - q2 + (13*pi)/150) + 15*q3*qd1*qd3*sin(q1 - q2 + (13*pi)/150) - 30*q3*qd1*qd3*sin(q2 - q1 + (13*pi)/150) - 60*q3*qd1*qd2*sin(q2 - 3*q1 + (13*pi)/150) - 45*q3*qd1*qd2*sin(3*q1 + q2 - (13*pi)/150) - (15*q3*qd2*qd3*sin(q1 - q2 + (13*pi)/150))/2 - 45*q3*qd1*qd3*sin(q2 - 3*q1 + (13*pi)/150) - 45*q3*qd1*qd3*sin(3*q1 + q2 - (13*pi)/150) - (15*q3*qd2*qd3*sin(q2 - 3*q1 + (13*pi)/150))/2 - (15*q3*qd2*qd3*sin(3*q1 + q2 - (13*pi)/150))/2 - (q3*qd1*qd3*cos(q1))/4 - (q3*qd1*qd3*cos(q1 - (13*pi)/75))/4 + (q3*qd1*qd3*sin(q1))/4 + (q3*qd1*qd3*cos((13*pi)/75))/2 - (q3*qd1*qd3*cos(4*q1 - (13*pi)/75))/2];
W(2+3*(i-1),:)=[   0,    0, qdd1, qdd2,    0, qdd1, qdd2,    0,    0,    0, qdd1, qdd2,    0, qdd1, qdd2,    0,        0, qdd2 + (qdd2*cos(2*q1))/2 + (qdd1*sin(2*q2))/4 - (qd1^2*sin(2*q2))/2 + (qdd2*cos(2*q1)*cos(2*q2))/2 + (qdd1*cos(2*q1)*sin(2*q2))/4 - (qdd1*sin(2*q1)*sin(2*q2))/4 - (qd1*qd2*cos(2*q2))/4 - (qd1*qd2*sin(2*q1))/2 - (qd1^2*cos(2*q1)*sin(2*q2))/2 - (qd2^2*cos(2*q1)*sin(2*q2))/2 - (qd1^2*sin(2*q1)*sin(2*q2))/2 - (qd1*qd2*cos(2*q1)*cos(2*q2))/4 - (3*qd1*qd2*cos(2*q1)*sin(2*q2))/4 - (qd1*qd2*cos(2*q2)*sin(2*q1))/4 - (qd1*qd3*cos(2*q1)*sin(2*q2))/4 - (qd2*qd3*cos(2*q1)*sin(2*q2))/2 - (qd1*qd2*sin(2*q1)*sin(2*q2))/4 - (qd1*qd3*sin(2*q1)*sin(2*q2))/4,                 cos(q1)*cos(q2),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      qdd2 + (qdd1*sin(2*q2))/4 - (qd1^2*sin(2*q2))/2 - (qdd1*cos(2*q1)*sin(2*q2))/4 - (qdd1*sin(2*q1)*sin(2*q2))/4 - (qd1*qd2*cos(2*q2))/4 + (qd1^2*sin(2*q1)*sin(2*q2))/2 + (qd1*qd2*cos(2*q1)*cos(2*q2))/4 - (qd1*qd2*cos(2*q1)*sin(2*q2))/4 + (qd1*qd2*cos(2*q2)*sin(2*q1))/4 - (qd1*qd3*cos(2*q1)*sin(2*q2))/4 + (qd1*qd2*sin(2*q1)*sin(2*q2))/4 + (qd1*qd3*sin(2*q1)*sin(2*q2))/4,                 cos(q1)*cos(q2), qdd2 - (qd1^2*cos((13*pi)/75)*sin(2*q2))/2 + (qd1^2*sin((13*pi)/75)*cos(2*q2))/2, 120*qdd2*cos((13*pi)/150) - 60*qd1^2*cos((13*pi)/150)*sin(2*q2) + 60*qd1^2*sin((13*pi)/150)*cos(2*q2), cos((13*pi)/150)*cos(q1)*cos(q2) + sin((13*pi)/150)*cos(q1)*sin(q2), 0, 0, 0,                                      - 1800*sin(2*q2)*qd1^2 + 3600*qdd2 + 60*cos(q1)*cos(q2),               3700*qdd2 + 60*cos(q1)*cos(q2) - 1800*qd1^2*sin(2*q2) + 1200*qdd2*cos((13*pi)/150) + 10*cos((13*pi)/150)*cos(q1)*cos(q2) + 10*sin((13*pi)/150)*cos(q1)*sin(q2) - 50*qd1^2*cos((13*pi)/75)*sin(2*q2) + 50*qd1^2*sin((13*pi)/75)*cos(2*q2) - 600*qd1^2*cos((13*pi)/150)*sin(2*q2) + 600*qd1^2*sin((13*pi)/150)*cos(2*q2),          - 1800*sin(2*q2)*qd1^2 + 3600*qdd2 + 60*cos(q2),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 3600*qdd2 + 60*cos(q1)*cos(q2) - 1800*qd1^2*sin(2*q2) + 1800*qdd1*sin(2*q1)*sin(2*q2) + 3600*qd1^2*cos(2*q1)*sin(2*q2) - 30*qdd3*cos((13*pi)/150)*cos(q2) + 30*qdd3*sin((13*pi)/150)*cos(q2) - 1500*qdd1*sin((13*pi)/150)*sin(3*q1)*cos(q2) + 30*qdd3*sin((13*pi)/150)*sin(2*q1)*cos(q2) - 9000*qd1^2*sin((13*pi)/150)*sin(q1)*sin(q2) + 30*qd1*qd3*cos((13*pi)/150)*cos(q2) - 30*qd1*qd3*sin((13*pi)/150)*cos(q2) - 15*qd2*qd3*cos((13*pi)/150)*sin(q2) + 15*qd2*qd3*sin((13*pi)/150)*sin(q2) + 10500*qdd1*cos((13*pi)/150)*cos(q1)*cos(q2) - 60*qdd3*cos((13*pi)/150)*cos(q1)*sin(q2) - 9000*qdd1*cos((13*pi)/150)*sin(q1)*sin(q2) + 9000*qdd1*sin((13*pi)/150)*cos(q1)*sin(q2) + 7500*qdd1*sin((13*pi)/150)*cos(q2)*sin(q1) + 1800*qd1*qd2*cos(2*q1)*sin(2*q2) - 1800*qd1*qd2*cos(2*q2)*sin(2*q1) + 1800*qd1*qd3*cos(2*q1)*sin(2*q2) - 60*qdd3*sin((13*pi)/150)*sin(q1)*sin(q2) - 1500*qdd1*cos((13*pi)/150)*cos(3*q1)*cos(q2) + 30*qdd3*cos((13*pi)/150)*cos(2*q1)*cos(q2) - 30*qdd3*cos((13*pi)/150)*sin(2*q1)*cos(q2) + 30*qdd3*sin((13*pi)/150)*cos(2*q1)*cos(q2) - 9000*qd1^2*cos((13*pi)/150)*cos(q1)*sin(q2) - 18000*qd1^2*cos((13*pi)/150)*cos(q2)*sin(q1) + 6000*qd1^2*sin((13*pi)/150)*cos(q1)*cos(q2) + 750*qd1*qd2*cos((13*pi)/150)*cos(q1)*sin(q2) - 750*qd1*qd2*cos((13*pi)/150)*cos(q2)*sin(q1) - 750*qd1*qd2*sin((13*pi)/150)*cos(q1)*cos(q2) - 4500*qd1*qd3*cos((13*pi)/150)*cos(q1)*sin(q2) - 5250*qd1*qd3*cos((13*pi)/150)*cos(q2)*sin(q1) + 3750*qd1*qd3*sin((13*pi)/150)*cos(q1)*cos(q2) + 60*q3*qdd1*cos((13*pi)/150)*sin(q1)*sin(q2) - 60*q3*qdd1*sin((13*pi)/150)*cos(q1)*sin(q2) - 30*q3*qdd1*sin((13*pi)/150)*cos(q2)*sin(q1) + 60*qd1*qd3*cos((13*pi)/150)*sin(q1)*sin(q2) - 60*qd1*qd3*sin((13*pi)/150)*cos(q1)*sin(q2) - 15*qd1*qd3*sin((13*pi)/150)*cos(q2)*sin(q1) + 30*qd2*qd3*sin((13*pi)/150)*cos(q2)*sin(q1) - 750*qd1*qd2*sin((13*pi)/150)*sin(q1)*sin(q2) - 4500*qd1*qd3*sin((13*pi)/150)*sin(q1)*sin(q2) + 30*q3*qdd1*cos((13*pi)/150)*cos(3*q1)*cos(q2) - 60*qd1*qd3*cos((13*pi)/150)*cos(2*q1)*cos(q2) + 15*qd1*qd3*cos((13*pi)/150)*cos(3*q1)*cos(q2) + 60*q3*qd1^2*cos((13*pi)/150)*cos(q1)*sin(q2) + 180*q3*qd1^2*cos((13*pi)/150)*cos(q2)*sin(q1) - 60*q3*qd1^2*sin((13*pi)/150)*cos(q1)*cos(q2) - 750*qd1*qd2*cos((13*pi)/150)*cos(3*q1)*sin(q2) + 2250*qd1*qd2*cos((13*pi)/150)*sin(3*q1)*cos(q2) - 2250*qd1*qd2*sin((13*pi)/150)*cos(3*q1)*cos(q2) + 2250*qd1*qd3*cos((13*pi)/150)*sin(3*q1)*cos(q2) - 2250*qd1*qd3*sin((13*pi)/150)*cos(3*q1)*cos(q2) + 15*qd2*qd3*cos((13*pi)/150)*cos(2*q1)*sin(q2) + 30*q3*qdd1*sin((13*pi)/150)*sin(3*q1)*cos(q2) - 60*qd1*qd3*sin((13*pi)/150)*sin(2*q1)*cos(q2) + 15*qd1*qd3*sin((13*pi)/150)*sin(3*q1)*cos(q2) - 15*qd2*qd3*cos((13*pi)/150)*sin(2*q1)*sin(q2) + 15*qd2*qd3*sin((13*pi)/150)*cos(2*q1)*sin(q2) + 60*q3*qd1^2*sin((13*pi)/150)*sin(q1)*sin(q2) - 750*qd1*qd2*sin((13*pi)/150)*sin(3*q1)*sin(q2) + 15*qd2*qd3*sin((13*pi)/150)*sin(2*q1)*sin(q2) - 60*q3*qd1^2*cos((13*pi)/150)*sin(3*q1)*cos(q2) + 60*q3*qd1^2*sin((13*pi)/150)*cos(3*q1)*cos(q2) - 90*q3*qdd1*cos((13*pi)/150)*cos(q1)*cos(q2) - 45*qd1*qd3*cos((13*pi)/150)*cos(q1)*cos(q2) + 30*qd2*qd3*cos((13*pi)/150)*cos(q1)*cos(q2) - 15*q3*qd1*qd2*cos((13*pi)/150)*cos(q1)*sin(q2) + 15*q3*qd1*qd2*cos((13*pi)/150)*cos(q2)*sin(q1) + 15*q3*qd1*qd2*sin((13*pi)/150)*cos(q1)*cos(q2) + 30*q3*qd1*qd3*cos((13*pi)/150)*cos(q1)*sin(q2) + 45*q3*qd1*qd3*cos((13*pi)/150)*cos(q2)*sin(q1) - 15*q3*qd1*qd3*sin((13*pi)/150)*cos(q1)*cos(q2) + 15*q3*qd1*qd2*sin((13*pi)/150)*sin(q1)*sin(q2) + 30*q3*qd1*qd3*sin((13*pi)/150)*sin(q1)*sin(q2) + 15*q3*qd1*qd2*cos((13*pi)/150)*cos(3*q1)*sin(q2) - 45*q3*qd1*qd2*cos((13*pi)/150)*sin(3*q1)*cos(q2) + 45*q3*qd1*qd2*sin((13*pi)/150)*cos(3*q1)*cos(q2) - 45*q3*qd1*qd3*cos((13*pi)/150)*sin(3*q1)*cos(q2) + 45*q3*qd1*qd3*sin((13*pi)/150)*cos(3*q1)*cos(q2) + 15*q3*qd1*qd2*sin((13*pi)/150)*sin(3*q1)*sin(q2)];
W(3+3*(i-1),:)=[   0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,        0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 0,                               0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      0,                               0,                                                                                0,                                                                                                     0,                                                                   0, 0, 0, 0,                                                                                            0,                                                                                                                                                                                                                                                                                                                                    0,                                                        0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     (3*qdd3)/2 + sin((13*pi)/150)/2 - sin(2*q1 - (13*pi)/150)/2 - 25*qd1^2*cos(q1) + 50*qdd1*cos(3*q1 - (13*pi)/75) - (qdd3*cos(2*q1 - (13*pi)/75))/2 - 50*qd1^2*cos(q1 - (13*pi)/75) - 15*qd2^2*cos(q2 - (13*pi)/150) + 15*qd2^2*cos(q2 + (13*pi)/150) + 25*qd1^2*sin(q1) + 75*qdd1*sin(2*q1 - (13*pi)/75) - 25*qdd1*sin(3*q1 - (13*pi)/75) + 25*qd1^2*sin(q1 - (13*pi)/75) + 15*qd2^2*sin(q2 - (13*pi)/150) + 15*qd2^2*sin(q2 + (13*pi)/150) - 30*qdd2*sin(q1 + q2 - (13*pi)/150) + 50*qd1^2*cos((13*pi)/75) + 125*qd1^2*cos(2*q1 - (13*pi)/75) - 75*qd1^2*cos(3*q1 - (13*pi)/75) - 50*qd1^2*cos(4*q1 - (13*pi)/75) - 150*qd1^2*sin(3*q1 - (13*pi)/75) - 15*qdd1*cos(q2 - 2*q1 + (13*pi)/150) + 15*qdd1*cos(2*q1 + q2 - (13*pi)/150) + 15*qdd2*cos(q2 - 2*q1 + (13*pi)/150) + 15*qdd2*cos(2*q1 + q2 - (13*pi)/150) - 30*qd1^2*cos(q1 + q2 - (13*pi)/150) - 15*qd1^2*cos(q1 + q2 + (13*pi)/150) - 30*qd2^2*cos(q1 + q2 - (13*pi)/150) + 15*qdd1*sin(q2 - 2*q1 + (13*pi)/150) + 15*qdd1*sin(2*q1 + q2 - (13*pi)/150) - 30*qdd2*sin(q2 - q1 + (13*pi)/150) + 15*qdd2*sin(q2 - 2*q1 + (13*pi)/150) - 15*qdd2*sin(2*q1 + q2 - (13*pi)/150) - (3*q3*qd1^2)/2 - 25*qdd1*cos(q1) - 25*qdd1*cos(q1 - (13*pi)/75) + 15*qdd1*cos(q2 - (13*pi)/150) - 15*qdd1*cos(q2 + (13*pi)/150) - 15*qdd2*cos(q2 - (13*pi)/150) - 15*qdd2*cos(q2 + (13*pi)/150) - 25*qdd1*sin(q1) - 50*qdd1*sin(q1 - (13*pi)/75) - 15*qdd1*sin(q2 - (13*pi)/150) - 15*qdd1*sin(q2 + (13*pi)/150) - 15*qdd2*sin(q2 - (13*pi)/150) + 15*qdd2*sin(q2 + (13*pi)/150) + 175*qd1^2 + 15*qd1^2*cos(q1 - q2 + (13*pi)/150) + 30*qd1^2*cos(q2 - q1 + (13*pi)/150) - 30*qd1^2*cos(q2 - 2*q1 + (13*pi)/150) + 30*qd1^2*cos(2*q1 + q2 - (13*pi)/150) - 30*qd2^2*cos(q2 - q1 + (13*pi)/150) + 15*qd1^2*cos(q2 - 3*q1 + (13*pi)/150) - 15*qd1^2*cos(3*q1 + q2 - (13*pi)/150) + 15*qd2^2*cos(q2 - 2*q1 + (13*pi)/150) - 15*qd2^2*cos(2*q1 + q2 - (13*pi)/150) - 30*qd1^2*sin(q2 - 2*q1 + (13*pi)/150) - 30*qd1^2*sin(2*q1 + q2 - (13*pi)/150) - 15*qd2^2*sin(q2 - 2*q1 + (13*pi)/150) - 15*qd2^2*sin(2*q1 + q2 - (13*pi)/150) - 45*qd1*qd2*sin(2*q1 + q2 - (13*pi)/150) - 15*qd1*qd3*sin(q2 - 2*q1 + (13*pi)/150) - 15*qd1*qd3*sin(2*q1 + q2 - (13*pi)/150) - (15*qd2*qd3*sin(q2 - 2*q1 + (13*pi)/150))/2 - (15*qd2*qd3*sin(2*q1 + q2 - (13*pi)/150))/2 + (q3*qdd1*cos(q1))/2 - (25*qd1*qd2*cos(q1))/2 - (51*qd1*qd3*cos(q1))/4 - 25*qd1*qd2*cos(q1 - (13*pi)/75) - 25*qd1*qd3*cos(q1 - (13*pi)/75) - 15*qd1*qd2*cos(q2 - (13*pi)/150) - (15*qd2*qd3*cos(q2 - (13*pi)/150))/2 + (15*qd2*qd3*cos(q2 + (13*pi)/150))/2 + (q3*qdd1*sin(q1))/2 + (25*qd1*qd2*sin(q1))/2 + (49*qd1*qd3*sin(q1))/4 + (q3*qdd1*sin(q1 - (13*pi)/75))/2 + (25*qd1*qd2*sin(q1 - (13*pi)/75))/2 + (49*qd1*qd3*sin(q1 - (13*pi)/75))/4 + 15*qd1*qd2*sin(q2 + (13*pi)/150) + (15*qd2*qd3*sin(q2 - (13*pi)/150))/2 + (15*qd2*qd3*sin(q2 + (13*pi)/150))/2 + (q3*qd1^2*cos(q1))/2 - (q3*qdd1*cos(3*q1 - (13*pi)/75))/2 + (q3*qd1^2*cos(q1 - (13*pi)/75))/2 + 75*qd1*qd2*cos(2*q1 - (13*pi)/75) - (75*qd1*qd2*cos(3*q1 - (13*pi)/75))/2 + 75*qd1*qd3*cos(2*q1 - (13*pi)/75) - (149*qd1*qd3*cos(3*q1 - (13*pi)/75))/4 - (q3*qd1^2*sin(q1))/2 - (q3*qdd1*sin(2*q1 - (13*pi)/75))/2 - 75*qd1*qd2*sin(3*q1 - (13*pi)/75) + (3*qd1*qd3*sin(2*q1 - (13*pi)/75))/4 - 75*qd1*qd3*sin(3*q1 - (13*pi)/75) + 30*qd1*qd2*cos(q1 + q2 - (13*pi)/150) + 15*qd1*qd2*cos(q1 + q2 + (13*pi)/150) - 15*qd2*qd3*cos(q1 + q2 - (13*pi)/150) - (q3*qd1^2*cos((13*pi)/75))/2 - (q3*qd1^2*cos(2*q1 - (13*pi)/75))/2 + (q3*qd1^2*cos(4*q1 - (13*pi)/75))/2 + (3*q3*qd1^2*sin(3*q1 - (13*pi)/75))/2 + 15*qd1*qd2*cos(q1 - q2 + (13*pi)/150) - 15*qd1*qd2*cos(q2 - 2*q1 + (13*pi)/150) - 15*qd1*qd2*cos(q2 - 3*q1 + (13*pi)/150) - 15*qd1*qd2*cos(3*q1 + q2 - (13*pi)/150) - 15*qd1*qd3*cos(q2 - 2*q1 + (13*pi)/150) + 15*qd1*qd3*cos(2*q1 + q2 - (13*pi)/150) - 15*qd2*qd3*cos(q2 - q1 + (13*pi)/150) + (15*qd2*qd3*cos(q2 - 2*q1 + (13*pi)/150))/2 - (15*qd2*qd3*cos(2*q1 + q2 - (13*pi)/150))/2 + (3*q3*qd1*qd2*sin(3*q1 - (13*pi)/75))/4 + (3*q3*qd1*qd3*sin(3*q1 - (13*pi)/75))/4 + (q3*qd1*qd2*cos(q1))/4 + (q3*qd1*qd3*cos(q1))/4 + (q3*qd1*qd2*cos(q1 - (13*pi)/75))/4 + (q3*qd1*qd3*cos(q1 - (13*pi)/75))/4 - (q3*qd1*qd2*sin(q1))/4 - (q3*qd1*qd3*sin(q1))/4 - (q3*qd1*qd2*cos(2*q1 - (13*pi)/75))/2 - (q3*qd1*qd3*cos(2*q1 - (13*pi)/75))/2];
     
end

%P_W=inv(W'*W)*W';

[U,De,V]=svd(W);
De_e=De(1:31,1:31);
De(1:31,1:31)=inv(De_e);
P_W=V*De'*U';

Par=P_W*torque'; 
csvwrite('parameters.csv',Par)